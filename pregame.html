<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Setup</title>
    <style>
        /* ... existing styles ... */
        
        /* Add these new styles */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }

        .progress-indicator {
            text-align: center;
            margin-bottom: 20px;
            color: #00ff9d;
        }

        .progress-indicator span {
            margin: 0 10px;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .progress-indicator span.active {
            background: #00ff9d;
            color: #1a1a1a;
        }

        .progress-indicator span.completed {
            background: #00cc7d;
            color: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Match Setup</h1>
        <div class="error-container" id="errorContainer"></div>
        
        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <span id="step1" class="active">1. Game Setup</span>
            <span id="step2">2. Batsmen & Bowler</span>
        </div>

        <!-- Pre-game Setup Section -->
        <div id="pregameSection" class="section active">
            <div class="setup-section">
                <div class="form-group">
                    <label for="gamePreset">Select Game:</label>
                    <select id="gamePreset" onchange="handlePresetChange()">
                        <option value="custom">Custom Game</option>
                        <option value="preset1">Game 1: Team A vs Team B (12 Overs)</option>
                        <option value="preset2">Game 2: Team C vs Team D (16 Overs)</option>
                        <option value="preset3">Game 3: Team E vs Team F (20 Overs)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="matchFormat">Match Format:</label>
                    <select id="matchFormat" required>
                        <option value="12">12 Overs</option>
                        <option value="16">16 Overs</option>
                        <option value="20">20 Overs</option>
                    </select>
                    <div class="error-message" id="formatError">Please select match format</div>
                </div>
                <div class="form-group">
                    <label for="teamA">Team A Name:</label>
                    <input type="text" id="teamA" required placeholder="Enter Team A name">
                    <div class="error-message" id="teamAError">Please enter Team A name</div>
                </div>
                <div class="form-group">
                    <label for="teamB">Team B Name:</label>
                    <input type="text" id="teamB" required placeholder="Enter Team B name">
                    <div class="error-message" id="teamBError">Please enter Team B name</div>
                </div>
                <div class="form-group">
                    <label for="battingFirst">Team Batting First:</label>
                    <select id="battingFirst" required>
                        <option value="A">Team A</option>
                        <option value="B">Team B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inningsTimer">Innings Timer (minutes):</label>
                    <input type="number" id="inningsTimer" value="20" min="1" max="60" required>
                    <div class="error-message" id="timerError">Please enter a valid timer value (1-60 minutes)</div>
                </div>
                <div class="button-group">
                    <button onclick="nextToBatsmen()" class="start-btn">Next: Batsmen Setup</button>
                    <button onclick="window.close()" class="close-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Batsmen Setup Section -->
        <div id="batsmenSection" class="section">
            <div class="setup-section">
                <h2>Batsmen & Bowler Setup</h2>
                <div class="form-group">
                    <label for="batsman1">Batsman 1:</label>
                    <input type="text" id="batsman1" required placeholder="Enter first batsman name">
                    <div class="error-message" id="batsman1Error">Please enter first batsman name</div>
                </div>
                <div class="form-group">
                    <label for="batsman2">Batsman 2:</label>
                    <input type="text" id="batsman2" required placeholder="Enter second batsman name">
                    <div class="error-message" id="batsman2Error">Please enter second batsman name</div>
                </div>
                <div class="form-group">
                    <label for="currentBowler">Current Bowler:</label>
                    <input type="text" id="currentBowler" required placeholder="Enter current bowler name">
                    <div class="error-message" id="bowlerError">Please enter current bowler name</div>
                </div>
                <div class="button-group">
                    <button onclick="startScoring()" class="start-btn">Start Scoring</button>
                    <button onclick="backToPregame()" class="close-btn">Back</button>
                    <button onclick="window.close()" class="close-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="debug-info" id="debugInfo"></div>
    </div>

    <script>
        // ... existing game presets and debug logging functions ...

        // Function to move to batsmen setup
        function nextToBatsmen() {
            try {
                if (!validateInputs()) {
                    throw new Error('Invalid inputs');
                }

                // Initialize match data
                const matchData = {
                    teamA: document.getElementById('teamA').value.trim(),
                    teamB: document.getElementById('teamB').value.trim(),
                    matchFormat: document.getElementById('matchFormat').value,
                    battingFirst: document.getElementById('battingFirst').value,
                    inningsTimer: parseInt(document.getElementById('inningsTimer').value),
                    currentInnings: 1,
                    scores: {
                        A: { runs: 0, wickets: 0, overs: 0, balls: 0 },
                        B: { runs: 0, wickets: 0, overs: 0, balls: 0 }
                    },
                    partnerships: {
                        A: [],
                        B: []
                    },
                    currentBatsmen: {
                        A: [],
                        B: []
                    },
                    currentBowler: null,
                    lastUpdated: new Date().toISOString()
                };

                // Store match data
                if (!isLocalStorageAvailable()) {
                    throw new Error('Local storage is not available');
                }

                localStorage.setItem('matchData', JSON.stringify(matchData));
                debugLog('Match data stored successfully');

                // Show batsmen section and hide pregame section
                document.getElementById('pregameSection').classList.remove('active');
                document.getElementById('batsmenSection').classList.add('active');
                
                // Update progress indicator
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step1').classList.add('completed');
                document.getElementById('step2').classList.add('active');

            } catch (error) {
                debugLog(`Error in nextToBatsmen: ${error.message}`);
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.textContent = `Error: ${error.message}`;
                    errorContainer.classList.add('show');
                }
            }
        }

        // Function to go back to pregame setup
        function backToPregame() {
            document.getElementById('batsmenSection').classList.remove('active');
            document.getElementById('pregameSection').classList.add('active');
            
            // Update progress indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('active');
        }

        // Function to start scoring
        function startScoring() {
            try {
                const batsman1 = document.getElementById('batsman1').value.trim();
                const batsman2 = document.getElementById('batsman2').value.trim();
                const currentBowler = document.getElementById('currentBowler').value.trim();

                if (!batsman1 || !batsman2 || !currentBowler) {
                    throw new Error('Please fill in all batsmen and bowler fields');
                }

                // Update match data with current batsmen and bowler
                const matchData = JSON.parse(localStorage.getItem('matchData'));
                const battingTeam = matchData.battingFirst;
                
                matchData.currentBatsmen[battingTeam] = [batsman1, batsman2];
                matchData.currentBowler = currentBowler;
                matchData.lastUpdated = new Date().toISOString();

                localStorage.setItem('matchData', JSON.stringify(matchData));
                debugLog('Batsmen and bowler data stored successfully');

                // Open scoreboard window
                const scoreboardWindow = window.open('scoreboard.html', 'Scoreboard', 
                    'width=800,height=600,resizable=yes,scrollbars=yes,menubar=no,toolbar=no,location=no,status=no');
                
                if (!scoreboardWindow) {
                    throw new Error('Failed to open scoreboard window. Please allow popups.');
                }

                // Close this window
                window.close();

            } catch (error) {
                debugLog(`Error in startScoring: ${error.message}`);
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.textContent = `Error: ${error.message}`;
                    errorContainer.classList.add('show');
                }
            }
        }

        // ... rest of the existing functions (validateInputs, isLocalStorageAvailable, etc.) ...

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Page loaded');

            // Check if page is opened as a popup
            if (!window.opener) {
                debugLog('Warning: Page not opened as a popup');
                alert('This page must be opened from the main scorer window.');
                window.close();
                return;
            }

            // Check if localStorage is available
            if (!isLocalStorageAvailable()) {
                debugLog('Error: Local storage not available');
                alert('Local storage is not available. Please enable it to use this application.');
                window.close();
                return;
            }

            // Log initial state
            debugLog('Initial localStorage state:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                debugLog(`${key}: ${localStorage.getItem(key)}`);
            }
        });
    </script>
</body>
</html>
