<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indoor Cricket Scorer</title>
    <style>
        /* ... existing styles ... */
        
        /* Add styles for the 7 runs button */
        .run-btn.seven {
            background: #ff6b6b;
        }
        
        .run-btn.seven:hover {
            background: #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Indoor Cricket Scorer</h1>
            <button onclick="openPreGameSetup()" class="start-btn">Start New Match</button>
        </div>

        <div class="timer-controls">
            <button onclick="startTimer(parseInt(localStorage.getItem('inningsTimer') || 20))" class="timer-btn">Start Timer</button>
            <button onclick="pauseTimer()" class="timer-btn">Pause Timer</button>
            <button onclick="resetTimer()" class="timer-btn">Reset Timer</button>
        </div>

        <div id="scoringControls" style="display: none;">
            <div class="runs-section">
                <button onclick="addRun(1)" class="run-btn">1 Run</button>
                <button onclick="addRun(2)" class="run-btn">2 Runs</button>
                <button onclick="addRun(3)" class="run-btn">3 Runs</button>
                <button onclick="addRun(4)" class="run-btn">4 Runs</button>
                <button onclick="addRun(5)" class="run-btn">5 Runs</button>
                <button onclick="addRun(6)" class="run-btn">6 Runs</button>
                <button onclick="addRun(7)" class="run-btn seven">7 Runs</button>
            </div>

            <div class="extras-section">
                <button onclick="addExtra('wides')" class="extra-btn">Wide</button>
                <button onclick="addExtra('noBalls')" class="extra-btn">No Ball</button>
                <button onclick="addExtra('byes')" class="extra-btn">Bye</button>
                <button onclick="addExtra('legByes')" class="extra-btn">Leg Bye</button>
            </div>

            <div class="wickets-section">
                <button onclick="wicket('bowled')" class="wicket-btn">Bowled</button>
                <button onclick="wicket('caught')" class="wicket-btn">Caught</button>
                <button onclick="wicket('runOut')" class="wicket-btn">Run Out</button>
                <button onclick="wicket('stumped')" class="wicket-btn">Stumped</button>
                <button onclick="wicket('hitWicket')" class="wicket-btn">Hit Wicket</button>
                <button onclick="wicket('obstructingField')" class="wicket-btn">Obstructing Field</button>
            </div>

            <div class="over-controls">
                <button onclick="endOver()" class="over-btn">End Over</button>
                <button onclick="changeBowler()" class="over-btn">Change Bowler</button>
            </div>
        </div>
    </div>

    <script>
        // Timer variables
        let timerInterval;
        let remainingTime;
        let isTimerRunning = false;

        // Open pre-game setup window
        function openPreGameSetup() {
            try {
                // Clear any existing match data
                localStorage.clear();
                
                // Open pre-game setup window
                const preGameWindow = window.open("pregame.html", "Pre-game Setup", 
                    "width=600,height=600,menubar=no,toolbar=no,location=no,status=no");
                
                // Check if popup was blocked
                if (!preGameWindow || preGameWindow.closed) {
                    alert("Please allow popups for this site to use the scorer");
                    return;
                }
                
                // Focus the new window
                preGameWindow.focus();
                
            } catch (error) {
                console.error("Error opening pre-game setup:", error);
                alert("Error opening pre-game setup window");
            }
        }

        // Timer functions
        function startTimer(minutes) {
            if (isTimerRunning) return;
            
            remainingTime = minutes * 60;
            isTimerRunning = true;
            
            // Store timer state
            localStorage.setItem("timerStatus", "Running");
            localStorage.setItem("timerDisplay", formatTime(remainingTime));
            
            timerInterval = setInterval(() => {
                remainingTime--;
                localStorage.setItem("timerDisplay", formatTime(remainingTime));
                
                // Check for warning time (5 minutes)
                if (remainingTime === 300) { // 5 minutes = 300 seconds
                    localStorage.setItem("timerStatus", "Warning - 5 minutes remaining!");
                    playBuzzer();
                }
                
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    localStorage.setItem("timerStatus", "Time's Up!");
                    playBuzzer();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!isTimerRunning) return;
            
            clearInterval(timerInterval);
            isTimerRunning = false;
            localStorage.setItem("timerStatus", "Paused");
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            remainingTime = parseInt(localStorage.getItem('inningsTimer') || 20) * 60;
            localStorage.setItem("timerDisplay", formatTime(remainingTime));
            localStorage.setItem("timerStatus", "Stopped");
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function playBuzzer() {
            const audio = new Audio('buzzer.mp3');
            audio.play().catch(error => console.error("Error playing buzzer:", error));
        }

        // Scoring functions
        function addRun(runs) {
            try {
                const matchData = JSON.parse(localStorage.getItem("matchData"));
                if (!matchData) return;

                const currentTeam = matchData.currentInnings === "A" ? "teamA" : "teamB";
                matchData[currentTeam].totalScore += runs;
                matchData[currentTeam].partnerships[matchData.currentPartnership] += runs;
                matchData.consecutiveDotBalls = 0;

                localStorage.setItem("matchData", JSON.stringify(matchData));
            } catch (error) {
                console.error("Error adding runs:", error);
            }
        }

        function addExtra(type) {
            try {
                const matchData = JSON.parse(localStorage.getItem("matchData"));
                if (!matchData) return;

                const currentTeam = matchData.currentInnings === "A" ? "teamA" : "teamB";
                matchData[currentTeam].extras[type]++;
                matchData[currentTeam].totalScore++;

                localStorage.setItem("matchData", JSON.stringify(matchData));
            } catch (error) {
                console.error("Error adding extra:", error);
            }
        }

        function wicket(type) {
            try {
                const matchData = JSON.parse(localStorage.getItem("matchData"));
                if (!matchData) return;

                const currentTeam = matchData.currentInnings === "A" ? "teamA" : "teamB";
                matchData[currentTeam].wickets++;
                matchData.currentPartnership++;
                matchData.consecutiveDotBalls = 0;

                if (matchData[currentTeam].wickets >= 10) {
                    endInnings();
                } else {
                    promptNewBatsmen();
                }

                localStorage.setItem("matchData", JSON.stringify(matchData));
            } catch (error) {
                console.error("Error recording wicket:", error);
            }
        }

        function endOver() {
            try {
                const matchData = JSON.parse(localStorage.getItem("matchData"));
                if (!matchData) return;

                matchData.currentOver++;
                matchData.currentBall = 0;

                if (matchData.currentOver >= parseInt(localStorage.getItem("matchFormat"))) {
                    endInnings();
                } else {
                    changeBowler();
                }

                localStorage.setItem("matchData", JSON.stringify(matchData));
            } catch (error) {
                console.error("Error ending over:", error);
            }
        }

        function changeBowler() {
            const newBowler = prompt("Enter new bowler's name:");
            if (newBowler) {
                try {
                    const matchData = JSON.parse(localStorage.getItem("matchData"));
                    if (!matchData) return;

                    matchData.currentBowler = newBowler;
                    localStorage.setItem("matchData", JSON.stringify(matchData));
                } catch (error) {
                    console.error("Error changing bowler:", error);
                }
            }
        }

        function promptNewBatsmen() {
            const batsman1 = prompt("Enter new batsman 1:");
            const batsman2 = prompt("Enter new batsman 2:");
            
            if (batsman1 && batsman2) {
                try {
                    const matchData = JSON.parse(localStorage.getItem("matchData"));
                    if (!matchData) return;

                    const currentTeam = matchData.currentInnings === "A" ? "teamA" : "teamB";
                    matchData[currentTeam].currentBatsmen = [batsman1, batsman2];
                    localStorage.setItem("matchData", JSON.stringify(matchData));
                } catch (error) {
                    console.error("Error updating batsmen:", error);
                }
            }
        }

        function endInnings() {
            try {
                const matchData = JSON.parse(localStorage.getItem("matchData"));
                if (!matchData) return;

                if (matchData.currentInnings === "A") {
                    matchData.currentInnings = "B";
                    matchData.currentOver = 0;
                    matchData.currentBall = 0;
                    matchData.currentPartnership = 0;
                    promptNewBatsmen();
                    changeBowler();
                } else {
                    alert("Match Complete!");
                    localStorage.clear();
                    window.location.reload();
                }

                localStorage.setItem("matchData", JSON.stringify(matchData));
            } catch (error) {
                console.error("Error ending innings:", error);
            }
        }

        // Initialize page
        document.addEventListener("DOMContentLoaded", function() {
            console.log("Main window loaded");
            
            // Clear any existing match data
            localStorage.clear();
            
            // Hide scoring controls initially
            document.getElementById("scoringControls").style.display = "none";
            
            // Check if match is in progress
            const matchData = localStorage.getItem("matchData");
            if (matchData) {
                document.getElementById("scoringControls").style.display = "block";
            }
        });
    </script>
</body>
</html>
